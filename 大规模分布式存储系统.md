# 大规模分布式存储系统原理解析与架构实战


**实时性很高的交易类业务**

共305页

# 基础篇
## 1概述
- 云计算
分布式技术+服务化技术+资源隔离和管理(虚拟化技术)

SAAS 软件及服务 最成熟
PAAS 平台即服务
IAAS 基础设施即服务

ZooKeeper
HBase: NoSQL键/值列存储数据库

- Hadoop生态
![Hadoop生态](https://pic1.zhimg.com/4107e092f0b7c1413bf8bd81570d1f74_b.jpg)

- 秒杀器
模拟HTTP交互的网络通信软件
秒杀区和普通网页交互有差别,分析判断


## 2存储系统

master-slave摸索
master: 1)分配任务slave执行 2)协同一致性  接收slave注册,slave死掉需要感知等.
应该将协同的工作分离开.

简化的分布式并行计算设计模型
Fourinone
**包工头/农民工/手工仓库/职介所**

![模型](http://i.imgur.com/7AFHvWm.png)

- 工头:分配任务,计算入口,运行完成退出.
- 职介所:介绍工人给工头  一致性处理  保持联系
- 工人:计算
- 手工仓库:输入输出数据交换


Hadoop:jar包发送到数据节点,计算向数据移动
storm:数据通过消息发送到计算节点,数据向计算移动
Fourinone模型数据和计算相当灵活,自由设计.

- 串行+并行结合满足更多需求

数据拆到不同机器,计算过程也可以拆开.划分多个环节.


- 工人计算的服务化


## 3分布式系统 

- 离线计算:hadoop,日志分析,数据挖掘
- 实时计算:增量计算
- 迭代计算:上一阶段是下一阶段的条件,保留中间结果
- DAG 有向无环图

- 总控节点
	1. 总控节点除了执行全局调度还要维护文件系统目录树,内存容量等成为性能瓶颈
	1. 只维护数据分片位置,一般不会成为瓶颈.google达到8000台机器,hadoop达到3000台机器.
	1. 如果成为瓶颈.增加一层元数据节点.

- 数据库扩容
	主从复制,提高系统读取能力.垂直拆分和水平拆分将数据分布到多个存储节点.

- 异构系统
	- 同构系统
	主从节点,数据完全相同.拷贝过程容易再次发生故障,不适合大规模分布式存储系统.
	- 异构系统
	将数据划分成大小接近的分片,每个分片的多个副本存在任一个存储节点上.恢复时整个集群参与恢复.恢复时间短.

- 两阶段提交协议(TWO-phase commit,2pc)
协调者 参与者.假设每个节点将记录操作日志到非易失性存储上.
阻塞协议,锁住更新.不能容错.
面临两种故障:
	- 参与者故障,可以使用超时机制
	- 协调组故障,记录到日志并同步到备用协调者.
- Paxos协议

	解决多个节点间一致性问题.

	- 批准
	proposer 发送accept消息给其他节点,acceptor接受/拒绝
	- 确认
	超过一半的acceptor接受,提议生效.proposer发送acknowledge消息通过所有acceptor提议生效.

Paxos协议可以保证正确性,不能严格保证可终止性.

Paxos协议保证同一个数据分片的多副本间的数据一致性.

2pc协议保证在多个数据分片操作的原子性.2pc保证多台服务器操作,要么全部成功,要么全部失败.
最大问题,无法处理协调者宕机.

两者结合,paxos解决2pc协议中协调者宕机问题.paxos选出新的协调者继续服务.

- Paxos协议用法:
	1. 全局的锁服务或者命名和配置服务
	1. 将用户数据复制到多个数据中心

- 跨机房部署
	1. 集群整体切换
	1. 单个集群跨机房
	1. paxos选主副本: 总控节点出现故障不影响工作节点.
	google spanner和megastore 都采用这种方式.降低对总控节点依赖.工程复杂度高.

# 范型篇
## 4分布式文件系统

- 内容分发网络(Content delivery network,CDN)
内容缓存到离用户最近的网络节点上,降低延迟.

- GFS
数据块(chunk)
元数据,文件到chunk命名空间,文件到chunk映射,chunk位置信息
采用追加模型
	- 追加流程
- 容错机制
	定期将内存中数据以checkpoint文件存储到磁盘上.
	每个校验和

垃圾回收一般在系统低峰运行.

采用标准的写时快照机制.只是增加chunk的引用计数,表示文件已经被引用了,等到修改该chunk时才拷贝数据,生成新的chunk

单master系统是可行,简化了系统,更好实现一致性.

注意:
新加入的集群的机器,限制迁移的数量.防止被压垮.

- Taobao File System(TFS)
Blog文件系统,用户上传的图片,文档,视频
特点:写入后基本读,很少更新.
	- 减少每次磁盘IO次数
	- **多个逻辑图文件共享一个物理文件**


- *租约机制????????*

不需要保存文件的目录信息.不需要维护文件与block的映射关系.
文件位置  (block_id,block offset)

高可用性(High Available,HA)

图片去重
图片去重是键值存储系统 
图片的更新和删除比较麻烦.

- Facebook Haystack
多个逻辑文件共享一个物理文件.

以物理卷轴的形式存储,每个卷轴比较大约100G

- 构成
	- 目录
	- 缓存
	- 存储

机器id/<卷id,photo>
只支持追加操作.

- CDN内容分发网络
边缘节点:离用户非常近的节点
	- IO密集型 采用Intel Atom 低功耗CPU

## 5分布键值系统




- Amazon Dynamo
最简单的方式存储数据的原始形式,不解析具体内容.组合P2P技术.


- Tair 分布式键值系统
有中心架构
分为持久化和非持久化两张使用方式


## 6分布式表格系统

提供表格模型.
- google bigtable
gfs+bigtable
megastore构建在bigtable上.提供更丰富的接口
spanner跨多个数据中心的数据库服务
行通过主键唯一标示

- 组成
	- 客户端
	- 主控服务器
	- 子表服务器

保证强一致性
bigtable本质是gfs上的一层分布式索引,解决了gfs遗留的一致性问题

- 子表的合并和分裂
- 实时性差


- megastore在bigtable上提供数据库功能支持,介于关系数据和nosql间的存储技术
支持事物





## 7分布式数据库

- 数据库扩展性

	- MySQL sharding
	在应用层划分数据,将不同数据分片划分到不同的关系数据库
	- microsoft sql azure
	数据库内部支持数据自动分片
	- 存储引擎重写分布式数据库

- 数据库中间层
最简单的方法在应用层分片,分布到多个节点.中间层屏蔽后端数据库拆分细节.

- microsoft sql azure



# 实践篇
## 8OceanBase架构初探
## 9分布式存储引擎
## 10数据库功能
## 11质量保证,运维及实践

#专题篇
## 12云存储
## 13大数据


